name: Sync and Process Clash Proxies with Telegram Notification (Full Sync Delete)

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  sync-process-commit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout self repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install pyyaml emoji

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Force clean workspace before pulling
      run: |
        git rm -rf .
        rm -rf *
        echo "âœ… Workspace completely cleaned"

    - name: Pull latest changes from self repo
      run: git pull origin main --rebase || true

    - name: Clone upstream repository
      run: git clone --depth 1 https://github.com/suiyuan8/clash.git upstream_repo

    - name: Process upstream proxies
      run: python process_proxies.py

    - name: List generated files
      run: ls -al suiyuan8_*.yaml || echo "âš ï¸ No generated files"

    - name: Count generated files
      id: count_files
      run: |
        count=$(ls -1 suiyuan8_*.yaml 2>/dev/null | wc -l)
        echo "count=$count" >> $GITHUB_OUTPUT

    - name: Update .last_count and send Telegram notification if changed
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        last_count_file=".last_count"
        current_count=${{ steps.count_files.outputs.count }}

        last_count=0
        if [ -f "$last_count_file" ]; then
          last_count=$(cat "$last_count_file")
        fi

        if [ "$current_count" -ne "$last_count" ]; then
          echo "File count changed from $last_count to $current_count"

          message="âš ï¸ ä»“åº“æ›´æ–°ï¼æ–‡ä»¶æ•°é‡ä» $last_count å˜æˆäº† $current_countï¼Œè¯·æ›´æ–°æ¨¡æ¿ï¼"

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$message"
        else
          echo "File count unchanged: $current_count"
        fi

        echo "$current_count" > "$last_count_file"

    - name: Commit and push all changes
      run: |
        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ”„ å®Œæ•´åŒæ­¥ä¸Šæ¸¸å¹¶æ¸…é™¤æ— æ•ˆæ–‡ä»¶"
          git push origin HEAD:main
        fi
