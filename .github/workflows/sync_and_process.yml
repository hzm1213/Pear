name: Sync and Process Clash Proxies with Telegram Notification (Full Safe Version)

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  sync-process-commit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout self repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install pyyaml emoji

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Clean old generated files
      run: |
        echo "ğŸ§¹ Cleaning old suiyuan8_*.yaml files..."
        git ls-files suiyuan8_*.yaml | xargs -r git rm -f || true
        rm -f suiyuan8_*.yaml || true
        git add -A
        git commit -m "ğŸ—‘ï¸ åˆ é™¤æ—§çš„ suiyuan8 æ–‡ä»¶" || echo "No old files to delete"

    - name: Pull latest local changes with rebase
      run: git pull --rebase origin main || true

    - name: Clone upstream suiyuan8/clash repository
      run: git clone --depth 1 https://github.com/suiyuan8/clash.git upstream_repo

    - name: Process upstream proxies
      run: python process_proxies.py

    - name: Show generated files for debug
      run: |
        echo "ğŸ“‚ è¾“å‡ºæ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -al suiyuan8_*.yaml 2>/dev/null || echo "âš ï¸ No suiyuan8_*.yaml generated"

    - name: Count generated files
      id: count_files
      run: |
        count=$(ls -1 suiyuan8_*.yaml 2>/dev/null | wc -l || echo 0)
        echo "count=$count" >> $GITHUB_OUTPUT
        echo "å½“å‰ç”Ÿæˆæ–‡ä»¶æ•°é‡ï¼š$count"

    - name: Update .last_count & Send Telegram Notification
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        last_count_file=".last_count"
        current_count=${{ steps.count_files.outputs.count }}
        last_count=0

        if [ -f "$last_count_file" ]; then
          last_count=$(cat "$last_count_file")
        fi

        if [ "$current_count" -ne "$last_count" ]; then
          echo "ğŸ“ˆ File count changed from $last_count to $current_count"
          message="âš ï¸ ä»“åº“æ›´æ–°ï¼æ–‡ä»¶æ•°é‡ä» $last_count å˜æˆäº† $current_countï¼Œè¯·æ›´æ–°æ¨¡æ¿ï¼"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$message"
        else
          echo "âœ… File count unchanged: $current_count"
        fi

        echo "$current_count" > "$last_count_file"

    - name: Commit and push all changes
      run: |
        git add -A suiyuan8_*.yaml .last_count || true
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–° Clash/URL èŠ‚ç‚¹æ–‡ä»¶å¹¶æ›´æ–° last_count"
          git push origin HEAD:main
        fi
