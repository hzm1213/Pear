name: Sync and Process Clash/URL Nodes with Telegram Notification

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  sync-process-commit:
    runs-on: ubuntu-latest

    steps:
    # Checkout self repository
    - name: Checkout self repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # Setup Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    # Install dependencies
    - name: Install dependencies
      run: pip install pyyaml emoji

    # Configure git
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    # Clean only old generated node files
    - name: Clean old generated files
      run: |
        git ls-files suiyuan8_*.yaml | xargs -r git rm -f
        rm -f suiyuan8_*.yaml
        echo "âœ… Old generated node files cleaned"

    # Pull latest changes from self repo
    - name: Pull latest changes from self repo
      run: git pull origin main --rebase || true

    # Clone upstream repository
    - name: Clone upstream suiyuan8/clash repository
      run: git clone --depth 1 https://github.com/suiyuan8/clash.git upstream_repo

    # Check working directory
    - name: Check working directory
      run: |
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç›®å½•æ–‡ä»¶:"
        ls -al

    # Run the process_proxies.py script
    - name: Process upstream proxies
      run: python ./process_proxies.py

    # List generated files
    - name: List generated files
      run: ls -al suiyuan8_*.yaml || echo "âš ï¸ No generated files"

    # Count generated files
    - name: Count generated files
      id: count_files
      run: |
        count=$(ls -1 suiyuan8_*.yaml 2>/dev/null | wc -l)
        echo "count=$count" >> $GITHUB_OUTPUT

    # Update .last_count and send Telegram notification if changed
    - name: Update .last_count and send Telegram notification if changed
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        last_count_file=".last_count"
        current_count=${{ steps.count_files.outputs.count }}

        last_count=0
        if [ -f "$last_count_file" ]; then
          last_count=$(cat "$last_count_file")
        fi

        if [ "$current_count" -ne "$last_count" ]; then
          echo "File count changed from $last_count to $current_count"

          message="âš ï¸ ä»“åº“æ›´æ–°ï¼æ–‡ä»¶æ•°é‡ä» $last_count å˜æˆäº† $current_countï¼Œè¯·æ›´æ–°æ¨¡æ¿ï¼"

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$message"
        else
          echo "File count unchanged: $current_count"
        fi

        echo "$current_count" > "$last_count_file"

    # Commit and push all changes
    - name: Commit and push all changes
      run: |
        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–° Clash/URL èŠ‚ç‚¹æ–‡ä»¶å¹¶æ›´æ–° last_count"
          git push origin HEAD:main
        fi
